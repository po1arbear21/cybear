m4_include(../../util/macro.f90.inc)

m4_divert(m4_ifdef({m4_triangle},0,-1))

module test_triangle_m

  use normalization_m, only: init_normconst
  use test_case_m,     only: test_case
  use triang_grid_m,   only: triang_grid
  use triangle_m,      only: triangulation
  use vector_m,        only: vector_int, vector_real

  implicit none

  private
  public test_triangle

contains

subroutine test_triangle()
  type(test_case)     :: tc
  type(triangulation) :: tr
  type(triang_grid)   :: g

  call tc%init("triangle")

  call tr%init()
  call tr%add_polygon([0.0, 0.1, 0.4, 0.7, 0.8, 0.6, 0.2], [0.3, 0.1, 0.0, 0.1, 0.5, 0.6, 0.6], closed = .true.)
  call tr%add_polygon([0.2, 0.5, 0.6, 0.4],[0.2, 0.1, 0.3, 0.45], closed = .true., hole = [0.5, 0.2])
  call tr%triangulate()
  call tc%assert_eq([2, 3, 8, 7, 1, 11, 8, 1, 2, 8, 11, 1, 8, 3, 9, 9, 4, 10, 4, 9, 3, 10, &
    &                4, 5, 10, 6, 11, 6, 10, 5, 11, 6, 7] , &
    &               tr%triangles%d(1:tr%triangles%n), "triangle: triangles")

  call tc%assert_eq([0.00, 0.30, 0.10, 0.10, 0.40, 0.00, 0.70, 0.10, 0.80, 0.50, 0.60, 0.60, 0.20, &
      &              0.60, 0.20, 0.20, 0.50, 0.10, 0.60, 0.30, 0.40, 0.45], &
      &               tr%xy%d(1:tr%xy%n), 1e-14, 1e-16, "triangle: points")

  call tr%init()
  call tr%add_polygon([0.0, 0.1, 0.4, 0.7, 0.8, 0.6, 0.2], [0.3, 0.1, 0.0, 0.1, 0.5, 0.6, 0.6], closed = .true.)
  call tr%add_polygon([0.2, 0.5, 0.6, 0.4],[0.2, 0.1, 0.3, 0.45], closed = .true., hole = [0.5, 0.2])
  call tr%triangulate(max_area = 0.005)

  call tc%assert_eq([18,15,12,16,18,12,20,30,25,19,13,2,31,33,29,31,29,11,9,24,14,8,18,17,53,57,51,59,14,4,5      &
    &               ,52,42,2,12,15,35,32,7,40,32,22,18,16,23,32,39,7,24,9,23,19,15,8,17,18,23,15,18,8,15,19,2     &
    &               ,37,26,28,26,34,35,21,36,1,1,13,21,8,27,19,36,21,27,3,23,16,9,17,23,13,19,27,23,3,24,28,36    &
    &               ,37,30,27,25,38,40,46,20,29,33,30,33,37,8,25,27,33,34,37,27,21,13,11,40,31,33,31,22,40,38,39  &
    &               ,39,32,40,33,22,34,33,30,20,31,40,22,30,36,27,1,36,28,22,35,34,37,34,26,30,37,36,32,35,22,44  &
    &               ,46,11,41,10,43,51,42,53,57,10,58,49,6,48,11,41,45,43,45,41,45,43,54,49,5,6,48,46,44,53,43,10 &
    &               ,11,45,44,11,46,40,48,47,46,44,45,50,38,46,47,6,47,48,50,48,44,53,42,54,54,52,50,48,50,49,58  &
    &               ,56,57,52,49,50,52,5,49,54,42,52,45,54,50,53,54,43,55,59,58,57,56,51,57,53,10,58,10,55,59,55  &
    &               ,9,4,56,58,14,59,9,4,58,59], &
    &               tr%triangles%d(1:tr%triangles%n),   "triangle: triangles max_area")

  call tc%assert_eq([0.000, 0.300, 0.100, 0.100, 0.400, 0.000, 0.700, 0.100, 0.800, 0.500, 0.600, 0.600, 0.200, 0.600, &
    &                0.200, 0.200, 0.500, 0.100, 0.600, 0.300, 0.400, 0.450, 0.250, 0.050, 0.050, 0.200, 0.550, 0.050, &
    &                0.202, 0.121, 0.325, 0.025, 0.350, 0.150, 0.286, 0.108, 0.125, 0.164, 0.300, 0.325, 0.053, 0.258, &
    &                0.250, 0.475, 0.399, 0.081, 0.475, 0.025, 0.250, 0.263, 0.100, 0.450, 0.151, 0.264, 0.050, 0.375, &
    &                0.350, 0.388, 0.209, 0.323, 0.319, 0.444, 0.250, 0.543, 0.236, 0.398, 0.181, 0.443, 0.150, 0.525, &
    &                0.095, 0.317, 0.145, 0.377, 0.400, 0.600, 0.300, 0.600, 0.339, 0.528, 0.500, 0.375, 0.775, 0.400, &
    &                0.595, 0.371, 0.539, 0.480, 0.551, 0.421, 0.449, 0.526, 0.500, 0.600, 0.550, 0.545, 0.675, 0.521, &
    &                0.621, 0.475, 0.750, 0.300, 0.714, 0.456, 0.675, 0.339, 0.650, 0.417, 0.550, 0.200, 0.725, 0.200, &
    &                0.675, 0.259, 0.638, 0.199, 0.600, 0.125], &
    &               tr%xy%d(1:tr%xy%n), 0.001, 0.001, "triangle: points max_area")

  call tr%get_grid("tr", g)
  call tc%assert_eq(tr%xy%n/2, size(g%vert, dim = 2), "triangle: get_grid")
  call tc%assert_eq(tr%triangles%n/3, size(g%cell2vert, dim = 2), "triangle: get_grid")
  ! call init_normconst(300.0)
  ! call g%output_plotmtv("tr", "1")

  call tc%finish()
end subroutine

end module

m4_divert(0)
