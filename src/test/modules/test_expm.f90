module test_expm_m
  use expm_m
  use matrix_m
  use test_case_m

  implicit none

  private
  public test_expm

contains

  subroutine test_expm()
    real, allocatable :: d0(:,:), expmA_exp(:,:)
    type(test_case)   :: tc
    type(dense_real)  :: A, expmA

    print "(A)", "test_expm"
    call tc%init("expm")

    ! A = magic(4) / 16 =
    !   1.0000    0.1250    0.1875    0.8125
    !   0.3125    0.6875    0.6250    0.5000
    !   0.5625    0.4375    0.3750    0.7500
    !   0.2500    0.8750    0.9375    0.0625
    d0 = reshape([1.000000000000000, 0.312500000000000, 0.562500000000000, 0.250000000000000, &
      &           0.125000000000000, 0.687500000000000, 0.437500000000000, 0.875000000000000, &
      &           0.187500000000000, 0.625000000000000, 0.375000000000000, 0.937500000000000, &
      &           0.812500000000000, 0.500000000000000, 0.750000000000000, 0.062500000000000], [4,4])
    call A%init(d0)

    ! expm(A) =
    !   3.4490    1.3513    1.4653    2.1073
    !   1.5488    3.0558    1.9740    1.7943
    !   1.8601    1.7766    2.7268    2.0094
    !   1.5150    2.1891    2.2068    2.4619
    expmA_exp = reshape([3.449025898232945, 1.548757140029917, 1.860091434229148, 1.515023015635252, &
      &                  1.351337786871065, 3.055848989651620, 1.776587022110675, 2.189123689493901, &
      &                  1.465252727911444, 1.974006375269527, 2.726816734386867, 2.206821650559423, &
      &                  2.107281075111807, 1.794284983176198, 2.009402297400571, 2.461929132438685], [4,4])

    call expm(A, expmA)
    call tc%assert_eq(expmA_exp, expmA%d, 1e-12, "expm(dense)")

    call tc%finish()
  end subroutine

end module
